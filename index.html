<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State & Insurance Settlement Funding Info - CBC Settlement Funding</title>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <!-- Google Fonts for Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* General Styling */
        body {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.6;
            padding-right: 220px;
        }

        /* Sidebar Styling */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 200px;
            height: 100%;
            background-color: #ffffff;
            color: #1f2937;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            border-left: 1px solid #e0e4e8;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .sidebar h3 {
            margin: 0 0 20px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            color: #003087;
            border-bottom: 1px solid #e0e4e8;
            padding-bottom: 10px;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar ul li {
            margin-bottom: 15px;
        }
        .sidebar ul li a {
            color: #003087;
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: color 0.3s ease;
        }
        .sidebar ul li a i {
            margin-right: 10px;
            font-size: 16px;
        }
        .sidebar ul li a:hover {
            color: #002060;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #003087;
            color: white;
            border: none;
            padding: 10px;
            font-size: 18px;
            cursor: pointer;
            z-index: 1100;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .sidebar-toggle:hover {
            background-color: #002060;
        }

        /* Header Styling */
        .header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(180deg, #003087, #002060);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .header img {
            max-width: 220px;
            height: auto;
        }

        /* Main Container */
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            background: linear-gradient(180deg, #ffffff, #f9fafb);
            border: 1px solid #e0e4e8;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Dropdown Styling */
        .dropdown {
            margin-bottom: 25px;
        }
        .dropdown label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1f2937;
        }
        .dropdown select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: #fff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .dropdown select:focus {
            border-color: #003087;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.1);
        }

        /* Select2 Styling */
        .select2-container {
            width: 100% !important;
        }
        .select2-selection {
            padding: 10px 12px;
            font-size: 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            height: 44px;
            line-height: 24px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .select2-selection__rendered {
            line-height: 24px !important;
        }
        .select2-selection__arrow {
            height: 42px !important;
            top: 1px !important;
        }
        .select2-container--default .select2-dropdown {
            margin-top: 0;
            border-top: 0;
            border-radius: 0 0 6px 6px;
            z-index: 1000;
        }

        /* Button Styling */
        .dropdown button {
            padding: 12px 24px;
            background-color: #003087;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .dropdown button:hover {
            background-color: #002060;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Checkbox Styling */
        .controls-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 25px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
        }
        .checkbox-container label {
            font-weight: 500;
            color: #1f2937;
            margin-left: 8px;
            cursor: pointer;
        }
        .checkbox-container input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #003087;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s ease;
        }
        .checkbox-container input[type="checkbox"]:checked {
            background-color: #003087;
        }
        .checkbox-container input[type="checkbox"]:checked::after {
            content: '\2713';
            color: white;
            font-size: 14px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Export Button Styling */
        .export-container {
            text-align: center;
            margin-top: 25px;
        }
        .export-button {
            padding: 12px 24px;
            background-color: #003087;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .export-button:hover:not(:disabled) {
            background-color: #002060;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .export-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .export-button i {
            margin-right: 8px;
        }

        /* Info Boxes Styling */
        .info-section {
            margin-top: 25px;
            padding: 20px;
            border: 1px solid #e0e4e8;
            border-radius: 6px;
            background-color: #fafafa;
            display: none;
            transition: all 0.3s ease;
        }
        .info-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e4e8;
        }
        .info-section h3 {
            margin: 0;
            color: #003087;
            font-size: 18px;
            font-weight: 500;
        }
        .info-section .toggle-section {
            background: none;
            border: none;
            cursor: pointer;
            color: #003087;
            font-size: 16px;
        }
        .info-section .section-content {
            padding-top: 15px;
            display: block;
        }
        .info-section .section-content.collapsed {
            display: none;
        }
        .info-section p, .info-section ul {
            margin: 10px 0;
            font-size: 14px;
        }
        .info-section p strong {
            color: #1f2937;
            font-weight: 500;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #003087;
            margin-left: 5px;
            font-size: 12px;
            border: 1px solid #003087;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 14px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tooltip:hover {
            background-color: #003087;
            color: white;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        #exportTooltip {
            display: inline;
        }
        #exportTooltip .tooltiptext {
            width: 150px;
            margin-left: -75px;
        }

        /* Loading Indicator */
        #loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #003087;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-right: 0;
            }
            .sidebar {
                transform: translateX(100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .sidebar-toggle {
                display: block;
            }
            .container {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar menu">
        <i class="fas fa-bars"></i>
    </button>
   <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <h3>Quick Links</h3>
    <ul>
        <li><a href="https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/EW5Qiva7E21JkbyIQax_C0MBIIiZNey8mg1l_u4FjxFvdQ?e=UOaht5" target="_blank" title="Download Advance Document"><i class="fas fa-file-alt"></i> Advance Document</a></li>
        <li><a href="https://cbcsettlementfundings-my.sharepoint.com/:b:/g/personal/jrairigh_cbcsettlementfunding_com/EceYDgEAuFFAsfhP8Bon9hABgCG3KMfmjaqWk-kXsgCiBQ?e=aKI9sk" target="_blank" title="Download Fasano Document"><i class="fas fa-file-alt"></i> Fasano Document</a></li>
        <li><a href="https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/EcfbEWrE5uFNk7rQ_vbiyuEBPB2Tx14mp6nGhSZMUMKgjw?e=dZl12V" target="_blank" title="Download Authorization to Release Information"><i class="fas fa-file-alt"></i> Authorization to Release Information</a></li>
        <li><a href="https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/EZGgcilwEdBHmnBywjSFM3ABdyIxBmjDIfvvk33fdfgP_A?e=0AkBOR" target="_blank" title="Download Best Interest Declaration"><i class="fas fa-file-alt"></i> Best Interest Declaration</a></li>
    </ul>
</div>
    <!-- Header -->
    <div class="header">
        <img src="https://i.postimg.cc/XJymhjMj/CBC-Logo.png" alt="CBC Settlement Funding Logo" id="headerLogo">
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="dropdown">
            <label for="stateSelect">Select a State:</label>
            <select id="stateSelect" aria-label="Select a state">
                <option value="">-- Select a State --</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="DC">Washington, D.C.</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
            </select>
        </div>

        <div class="dropdown">
            <label for="insuranceSelect">Select an Insurance Company:</label>
            <select id="insuranceSelect" aria-label="Select an insurance company">
                <option value="">-- Select an Insurance Company --</option>
                <option value="AL">Allstate Life Insurance Company</option>
                <option value="AF">American Family Mutual Insurance Co.</option>
                <option value="AG">American General</option>
                <option value="AM">Amica Life Insurance Company</option>
                <option value="AU">Aurora National Life Insurance Co.</option>
                <option value="AX">AXA Equitable</option>
                <option value="AT">Athene</option>
                <option value="BK">Berkshire</option>
                <option value="BH">Brighthouse</option>
                <option value="CL">Canada Life Assurance Company</option>
                <option value="CG">Connecticut General Life Co.</option>
                <option value="CN">Continental Life Insurance Company</option>
                <option value="FM">Farmers</option>
                <option value="FG">Fidelity and Guaranty Life Insurance Co.</option>
                <option value="FA">Fiduciary Association Benefits Co. (GABC)</option>
                <option value="GW">Genworth</option>
                <option value="HT">Hartford/Talcott</option>
                <option value="IL">Independent Life Insurance Company</option>
                <option value="IN">Insurance Company of North America</option>
                <option value="JH">John Hancock</option>
                <option value="LB">Liberty</option>
                <option value="LN">Lincoln National</option>
                <option value="MM">Mass Mutual</option>
                <option value="ML">MetLife</option>
                <option value="NY">NY Life</option>
                <option value="PL">Pacific Life</option>
                <option value="PR">Prudential</option>
                <option value="SN">Sentry Life Insurance Company</option>
                <option value="SF">State Farm</option>
                <option value="SY">Symetra</option>
                <option value="USNY">The United States Life Insurance Co. of NY</option>
                <option value="TA">Transamerica</option>
                <option value="UO">United of Omaha</option>
                <option value="US">USAA</option>
            </select>
        </div>

        <div class="dropdown">
            <button onclick="resetForm()" aria-label="Reset the form"><i class="fas fa-undo"></i> Reset</button>
        </div>

        <div class="controls-container">
            <div class="checkbox-container">
                <input type="checkbox" id="spiaCheckbox" onchange="toggleSpiaInfo()" aria-label="Show Single Premium Immediate Annuity information">
                <label for="spiaCheckbox">SPIA</label>
            </div>
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <p>Loading data...</p>
        </div>

        <div id="stateInfo" class="info-section"></div>
        <div id="insuranceInfo" class="info-section"></div>
        <div id="totalCosts" class="info-section"></div>
        <div id="spiaInfo" class="info-section"></div>

        <div class="export-container">
            <button class="export-button" id="exportButton" onclick="exportToPDF()" disabled aria-label="Export to PDF"><i class="fas fa-file-pdf"></i> Export to PDF</button>
            <span class="tooltip" id="exportTooltip"><span class="tooltiptext">Select a state, insurance company, or check SPIA to enable export.</span>?</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Define stateData and insuranceData globally
        const stateData = {
            "AL": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Brooke Davis", expectedLegalFee: "$2500", holdTime: "3" },
            "AK": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "Yes", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Jess Webster", expectedLegalFee: "$3500", holdTime: "10" },
            "AZ": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "Dec", noPoachState: "No", additionalNotes: "", legalCounsel: "Amy Schwartz", expectedLegalFee: "$2600", holdTime: "3" },
            "AR": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Whit Light", expectedLegalFee: "$2200", holdTime: "3" },
            "CA": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "Dec", 
                noPoachState: "No", 
                additionalNotes: "California has specific county rules. Orange County judges prefer effective rates below 20%, but deals have been done at 25% in the last 3-4 years, so it's not a hard rule. Fresno County is the hardest in the state; judges scrutinize all facts closely, including any priors, and may push for a lower rate to give the client more money (often requires IPA after approving the sale, which can be difficult).", 
                legalCounsel: "James Felton", 
                expectedLegalFee: "$4000", 
                holdTime: "10" 
            },
            "CO": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Chad McShane", expectedLegalFee: "$2750", holdTime: "3" },
            "CT": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Doug Evans", expectedLegalFee: "$3000", holdTime: "3" },
            "DE": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "Yes", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Rob Gibbs", expectedLegalFee: "$3500", holdTime: "10" },
            "DC": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "McMillan Metro (Elyse & Jose)", expectedLegalFee: "$2500", holdTime: "3" },
            "FL": { rateCap: "None but possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "Aff", noPoachState: "No", additionalNotes: "", legalCounsel: "Ken Dion", expectedLegalFee: "$2200", holdTime: "10" },
            "GA": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "Yes", additionalNotes: "", legalCounsel: "Shannon Carpenter", expectedLegalFee: "$2600", holdTime: "3" },
            "HI": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "TBD", expectedLegalFee: "$5000", holdTime: "1" },
            "ID": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Paul Okner", expectedLegalFee: "$2800", holdTime: "3" },
            "IL": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "No", 
                noPoachState: "No", 
                additionalNotes: "Cook County has specific rules. Cook County (Chicago) has an unwritten rule that effective rates need to be at 15.00% or below.", 
                legalCounsel: "Mack & Tragos", 
                expectedLegalFee: "$2500", 
                holdTime: "3" 
            },
            "IN": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Mack & Tragos", expectedLegalFee: "$2500", holdTime: "10" },
            "IA": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Mack & Tragos", expectedLegalFee: "$2500", holdTime: "3" },
            "KS": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Amber Steinbeck", expectedLegalFee: "$2300", holdTime: "3" },
            "KY": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Kevin Mack", expectedLegalFee: "$2700", holdTime: "N/A" },
            "LA": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "Yes", requiresAffDec: "No", noPoachState: "Yes", additionalNotes: "", legalCounsel: "John Toerner", expectedLegalFee: "$3000", holdTime: "10" },
            "ME": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "Yes", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Gray & Palmer", expectedLegalFee: "$2200", holdTime: "10" },
            "MD": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "Yes", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "McMillan Metro (Elyse & Jose)", expectedLegalFee: "$2500", holdTime: "10" },
            "MA": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Doug Evans", expectedLegalFee: "$3000", holdTime: "10" },
            "MI": { rateCap: "25%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Mack & Tragos", expectedLegalFee: "$2500", holdTime: "N/A" },
            "MN": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "Aff", noPoachState: "Yes", additionalNotes: "", legalCounsel: "Katrina Turman", expectedLegalFee: "$2750", holdTime: "10" },
            "MS": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Eric Dillon", expectedLegalFee: "$2100", holdTime: "3" },
            "MO": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Amber Steinbeck", expectedLegalFee: "$2300", holdTime: "10" },
            "MT": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Christopher Betchie", expectedLegalFee: "$3000", holdTime: "3" },
            "NE": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "No", 
                noPoachState: "No", 
                additionalNotes: "Lincoln County used to have judges who wanted all deals below 15.00%, but those judges are mostly retired, so deals can now be done at 29.99% if desired.", 
                legalCounsel: "Marc Odgaard", 
                expectedLegalFee: "$2500", 
                holdTime: "3" 
            },
            "NV": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "Aff", noPoachState: "Yes", additionalNotes: "", legalCounsel: "Hector Carabajal", expectedLegalFee: "$2800", holdTime: "3" },
            "NH": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Doug Evans", expectedLegalFee: "$3000", holdTime: "10" },
            "NJ": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "No", 
                noPoachState: "No", 
                additionalNotes: "New Jersey has varying county rules. Counties like Atlantic, Cumberland, Bergen, Middlesex, and Ocean have judges who may require rates at or below 15.00%, depending on the judge assigned.", 
                legalCounsel: "Dugalic & Landau", 
                expectedLegalFee: "$2800", 
                holdTime: "3" 
            },
            "NM": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Juan Marquez", expectedLegalFee: "$2800", holdTime: "3" },
            "NY": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "Aff", 
                noPoachState: "No", 
                additionalNotes: "New York has specific county rules. Judges vary by county on their opinion of these deals. In the 5 boroughs of NYC, deals are heavily scrutinized. Manhattan (New York County) needs to be priced in the high single digits/low double digits. Brooklyn (Kings County), Bronx (Bronx County), Queens (Queens County), and Staten Island (Richmond County) all differ; it's best to ask UW before pricing a New York file.", 
                legalCounsel: "Sacco & Fillas (Luigi)", 
                expectedLegalFee: "$3500", 
                holdTime: "10" 
            },
            "NC": { rateCap: "12.5% (5% above current prime rate, changes monthly)", requiresIPA: "Yes", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "RL Adams", expectedLegalFee: "$2850", holdTime: "N/A" },
            "ND": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Katrina Turman", expectedLegalFee: "$2750", holdTime: "3" },
            "OH": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "No", 
                noPoachState: "No", 
                additionalNotes: "Cuyahoga County has specific rules. Cuyahoga County (Cleveland) has an unwritten rule that the disclosure quotient must exceed 50.00% for court approval, but many deals have been completed below this threshold depending on cash flow, term of payments, purchase price, and the client's reasons for transfer.", 
                legalCounsel: "Steve Mastrantonio", 
                expectedLegalFee: "$2600", 
                holdTime: "10" 
            },
            "OK": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Henry Dow (Kathy Keener)", expectedLegalFee: "$1500", holdTime: "3" },
            "OR": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "Dec", noPoachState: "No", additionalNotes: "", legalCounsel: "Paul Okner", expectedLegalFee: "$2800", holdTime: "14" },
            "PA": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "Dec", 
                noPoachState: "No", 
                additionalNotes: "Pennsylvania has specific county rules. Allegheny County (Pittsburgh) has a rotation of 5 judges who try to get rates down to 15.00% or lower and will scrutinize the client's situation very closely.", 
                legalCounsel: "Dugalic & Landau / Margolis Edelstein (Ron Reitz)", 
                expectedLegalFee: "$2800 - $3000", 
                holdTime: "10" 
            },
            "RI": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Doug Evans", expectedLegalFee: "$3000", holdTime: "10" },
            "SC": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "Yes", additionalNotes: "", legalCounsel: "Richard (Rick) Steadman", expectedLegalFee: "$2300", holdTime: "3" },
            "SD": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Glenn L. Roth (JGW counsel)", expectedLegalFee: "$2500", holdTime: "3" },
            "TN": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "Aff", 
                noPoachState: "No", 
                additionalNotes: "Shelby County has specific rules. Shelby County (Memphis) has a judge whose initial reaction to applications is to deny the petition; there are no unwritten rules, and the judge reviews each case individually to determine what the client must show for approval (Shelby has 3 or 4 judges, so the odds of drawing this strict judge are 1 in 3 or 1 in 4).", 
                legalCounsel: "Kevin Mack", 
                expectedLegalFee: "$3000", 
                holdTime: "10" 
            },
            "TX": { 
                rateCap: "None but if possible stay under 24.99%", 
                requiresIPA: "No", 
                requiresAffDec: "No", 
                noPoachState: "No", 
                additionalNotes: "Harris County has specific rules. Harris County (Houston) has a few judges who prefer deals not to exceed 25%, but it depends on the judge assigned after filing; Texas counsel will provide a heads-up on the judge assignment, which is passed on to the rep and Mike immediately.", 
                legalCounsel: "Brian Dear", 
                expectedLegalFee: "$3000", 
                holdTime: "3" 
            },
            "UT": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Fabian VanCott (Clint Hansen is counsel)", expectedLegalFee: "$2850", holdTime: "3" },
            "VT": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "TBD", expectedLegalFee: "$3000", holdTime: "10" },
            "VA": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "McMillan Metro (Elyse & Jose)", expectedLegalFee: "$2500", holdTime: "3" },
            "WA": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Paul Okner", expectedLegalFee: "$2800", holdTime: "3" },
            "WV": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "Kay Casto", expectedLegalFee: "$3000", holdTime: "N/A" },
            "WI": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "Aff", noPoachState: "No", additionalNotes: "", legalCounsel: "Mack & Tragos", expectedLegalFee: "$2500", holdTime: "N/A" },
            "WY": { rateCap: "None but if possible stay under 24.99%", requiresIPA: "No", requiresAffDec: "No", noPoachState: "No", additionalNotes: "", legalCounsel: "TBD", expectedLegalFee: "$3000", holdTime: "3" }
        };

        const insuranceData = {
            "AL": { name: "Allstate Life Insurance Company", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$1,000.00", requestProcedure: "requires notary" },
            "AF": { name: "American Family Mutual Insurance Co.", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$750.00", requestProcedure: "TBD" },
            "AG": { 
                name: "American General", 
                notes: "Requires additional verification. We have contacts at the law firm representing this carrier, who are helpful with verifying payment streams ('clearing pays'). Send a signed authorization to release information and benefits request form (can be completed via DocuSign), including at least the policy number and DOB (clients may be reluctant to provide SS#).", 
                conferenceCalls: "No", 
                paymentConfirmation: "Call 1-800-555-1234", 
                creditRating: "A-", 
                adminFee: "$1,250.00", 
                requestProcedure: "original signature" 
            },
            "AM": { name: "Amica Life Insurance Company", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$1,000.00", requestProcedure: "TBD" },
            "AU": { name: "Aurora National Life Insurance Co.", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$850.00", requestProcedure: "TBD" },
            "AX": { 
                name: "AXA Equitable", 
                notes: "Standard processing. To verify pays, the process is identical to United of Omaha: signatures on request forms must be ink-signed.", 
                conferenceCalls: "No", 
                paymentConfirmation: "Contact customer service", 
                creditRating: "A", 
                adminFee: "$750.00", 
                requestProcedure: "accepts docusign" 
            },
            "AT": { name: "Athene", notes: "Requires notarized documents.", conferenceCalls: "Yes", paymentConfirmation: "Email to claims@athene.com", creditRating: "A", adminFee: "$1,000.00", requestProcedure: "original signature" },
            "BK": { 
                name: "Berkshire", 
                notes: "Quick processing. For Berkshire Hathaway Life Insurance Company of Nebraska/National Indemnity Company (common Berkshire payors), the process is almost identical to Hartford/Talcott: requires notarized request forms; upon receipt, they will process and send the requested docs with an updated benefits letter within a day at most.", 
                conferenceCalls: "Yes", 
                paymentConfirmation: "Call 1-800-555-5678", 
                creditRating: "AA+", 
                adminFee: "No Fee", 
                requestProcedure: "requires notary" 
            },
            "BH": { name: "Brighthouse", notes: "Delays possible.", conferenceCalls: "Yes", paymentConfirmation: "Online portal", creditRating: "A-", adminFee: "$1,250.00", requestProcedure: "accepts docusign" },
            "CL": { name: "Canada Life Assurance Company", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$250.00", requestProcedure: "requires notary" },
            "CG": { name: "Connecticut General Life Co.", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$750.00", requestProcedure: "TBD" },
            "CN": { name: "Continental Life Insurance Company", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$1,200.00", requestProcedure: "TBD" },
            "FM": { 
                name: "Farmers", 
                notes: "Policyholder must initiate. For Farmers New World Life Insurance Company, we have contacts at the law firm representing this carrier, who are helpful with verifying payment streams ('clearing pays'). Send a signed authorization to release information and benefits request form (can be completed via DocuSign), including at least the policy number and DOB (clients may be reluctant to provide SS#).", 
                conferenceCalls: "Yes", 
                paymentConfirmation: "Call 1-800-555-9012", 
                creditRating: "A", 
                adminFee: "$750.00", 
                requestProcedure: "requires notary" 
            },
            "FG": { name: "Fidelity and Guaranty Life Insurance Co.", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$900.00", requestProcedure: "TBD" },
            "FA": { name: "Fiduciary Association Benefits Co. (GABC)", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$1,500.00", requestProcedure: "original signature" },
            "GW": { name: "Genworth", notes: "Extended review for large settlements.", conferenceCalls: "Yes", paymentConfirmation: "Fax to 1-888-555-3456", creditRating: "BBB+", adminFee: "$750.00", requestProcedure: "original signature" },
            "HT": { 
                name: "Hartford/Talcott", 
                notes: "Requires court approval. Requires notarized request forms; upon receipt, Hartford/Talcott will process and send the requested annuity & settlement docs, with an updated benefits letter, within a day at most.", 
                conferenceCalls: "Yes", 
                paymentConfirmation: "Mail to Hartford office", 
                creditRating: "A", 
                adminFee: "$1,500.00", 
                requestProcedure: "requires notary" 
            },
            "IL": { name: "Independent Life Insurance Company", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$1,200.00", requestProcedure: "TBD" },
            "IN": { name: "Insurance Company of North America", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$1,000.00", requestProcedure: "TBD" },
            "JH": { 
                name: "John Hancock", 
                notes: "Fast track for small claims. The process is similar to Prudential: the benefits request letter must contain the policy number, DOB, and SS#. These can be completed via DocuSign, and UW will email or fax them to request the annuity & settlement docs. Turnaround time for an updated benefits letter varies between 1 day to 5-7 days, case by case.", 
                conferenceCalls: "No", 
                paymentConfirmation: "Online portal", 
                creditRating: "AA", 
                adminFee: "$1,000.00 for first deal, $1,350.00 for all subsequent deals", 
                requestProcedure: "accepts docusign" 
            },
            "LB": { name: "Liberty", notes: "Policy review takes 3-5 days.", conferenceCalls: "No", paymentConfirmation: "Email confirmation", creditRating: "A-", adminFee: "$850.00", requestProcedure: "requires notary" },
            "LN": { name: "Lincoln National", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$850.00", requestProcedure: "TBD" },
            "MM": { name: "Mass Mutual", notes: "Requires detailed payment history.", conferenceCalls: "Yes", paymentConfirmation: "Call 1-800-555-7890", creditRating: "AA+", adminFee: "$750.00", requestProcedure: "original signature" },
            "ML": { name: "MetLife", notes: "Processing may take extra time.", conferenceCalls: "Yes", paymentConfirmation: "Online portal or email", creditRating: "AA-", adminFee: "$1,250.00", requestProcedure: "requires notary" },
            "NY": { name: "NY Life", notes: "Strict documentation standards.", conferenceCalls: "No", paymentConfirmation: "Online portal", creditRating: "AA+", adminFee: "$1,000.00", requestProcedure: "original signature" },
            "PL": { name: "Pacific Life", notes: "Needs signed consent form.", conferenceCalls: "Yes", paymentConfirmation: "Fax to 1-888-555-5678", creditRating: "A+", adminFee: "$950.00", requestProcedure: "original signature" },
            "PR": { 
                name: "Prudential", 
                notes: "May require additional signatures. The benefits request letter must contain the policy number, DOB, and SS#. These can be completed via DocuSign, and UW will email or fax them to Prudential to request the annuity & settlement docs. Prudential takes 48-72 hours at most to fulfill the requests and send the docs back.", 
                conferenceCalls: "No", 
                paymentConfirmation: "Fax to 1-888-555-9012", 
                creditRating: "AA-", 
                adminFee: "$750.00 or $865.00", 
                requestProcedure: "accepts docusign" 
            },
            "SN": { name: "Sentry Life Insurance Company", notes: "Standard processing.", conferenceCalls: "No", paymentConfirmation: "Contact customer service", creditRating: "A", adminFee: "$750.00", requestProcedure: "TBD" },
            "SF": { name: "State Farm", notes: "Simple process for standard claims.", conferenceCalls: "No", paymentConfirmation: "Call 1-800-555-3456", creditRating: "AA", adminFee: "$750.00", requestProcedure: "requires notary" },
            "SY": { name: "Symetra", notes: "Requires policyholder affidavit.", conferenceCalls: "Yes", paymentConfirmation: "Email to support@symetra.com", creditRating: "A", adminFee: "Guaranteed - $1,500.00, Life Contingent - $3,210.00", requestProcedure: "requires notary" },
            "USNY": { 
                name: "The United States Life Insurance Co. of NY", 
                notes: "Standard processing. Also known as 'AIG-NY'. We have contacts at the law firm representing this carrier, who are helpful with verifying payment streams ('clearing pays'). Send a signed authorization to release information and benefits request form (can be completed via DocuSign), including at least the policy number and DOB (clients may be reluctant to provide SS#).", 
                conferenceCalls: "No", 
                paymentConfirmation: "Contact customer service", 
                creditRating: "A", 
                adminFee: "$1,250.00", 
                requestProcedure: "TBD" 
            },
            "TA": { name: "Transamerica", notes: "Submit policy copy with application.", conferenceCalls: "No", paymentConfirmation: "Mail to PO Box 1234", creditRating: "A", adminFee: "$1,100.00", requestProcedure: "original signature" },
            "UO": { 
                name: "United of Omaha", 
                notes: "Processing time varies. United of Omaha will verify pays (we have their legal and customer service department contacts), but signatures on the request forms must be ink-signed.", 
                conferenceCalls: "No", 
                paymentConfirmation: "Mail to Omaha office", 
                creditRating: "A+", 
                adminFee: "$750.00", 
                requestProcedure: "TBD" 
            },
            "US": { 
                name: "USAA", 
                notes: "Military verification may be needed. We have contacts at the law firm representing this carrier, who are helpful with verifying payment streams ('clearing pays'). Send a signed authorization to release information and benefits request form (can be completed via DocuSign), including at least the policy number and DOB (clients may be reluctant to provide SS#).", 
                conferenceCalls: "No", 
                paymentConfirmation: "Online portal", 
                creditRating: "AA+", 
                adminFee: "TBD", 
                requestProcedure: "TBD" 
            }
        };

        // Define parseFee globally
        function parseFee(feeStr) {
            if (!feeStr || feeStr === "TBD" || feeStr === "No Fee") return 0;
            if (feeStr.includes("-") || feeStr.includes("or")) {
                const separator = feeStr.includes("-") ? "-" : "or";
                const fees = feeStr.split(separator).map(f => parseFloat(f.replace(/[^0-9.]/g, "")) || 0);
                return fees.length === 2 ? (fees[0] + fees[1]) / 2 : 0;
            }
            if (feeStr.includes("Guaranteed") && feeStr.includes("Life Contingent")) {
                const fees = feeStr.match(/\$[0-9,.]+/g).map(f => parseFloat(f.replace(/[^0-9.]/g, "")) || 0);
                return fees.length === 2 ? (fees[0] + fees[1]) / 2 : 0;
            }
            if (feeStr.includes("for first deal")) {
                const fees = feeStr.match(/\$[0-9,.]+/g).map(f => parseFloat(f.replace(/[^0-9.]/g, "")) || 0);
                return fees.length === 2 ? (fees[0] + fees[1]) / 2 : 0;
            }
            return parseFloat(feeStr.replace(/[^0-9.]/g, "")) || 0;
        }

        // Toggle Sidebar
        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("active");
        }

        // Toggle Section
        function toggleSection(sectionId) {
            const content = document.querySelector(`#${sectionId} .section-content`);
            const header = document.querySelector(`#${sectionId} .section-header`);
            const isExpanded = !content.classList.contains("collapsed");
            content.classList.toggle("collapsed");
            header.setAttribute("aria-expanded", !isExpanded);
            const icon = document.querySelector(`#${sectionId} .toggle-section i`);
            icon.classList.toggle("fa-chevron-down");
            icon.classList.toggle("fa-chevron-up");
        }

        // Initialize Select2
        document.addEventListener("DOMContentLoaded", function() {
            $("#stateSelect").select2({ placeholder: "-- Select a State --", allowClear: true, dropdownParent: $(".container") });
            $("#insuranceSelect").select2({ placeholder: "-- Select an Insurance Company --", allowClear: true, dropdownParent: $(".container") });
            $("#stateSelect").on("change", updateInfo);
            $("#insuranceSelect").on("change", updateInfo);
        });

        // Reset Form
        function resetForm() {
            $("#stateSelect").val("").trigger("change");
            $("#insuranceSelect").val("").trigger("change");
            document.getElementById("stateInfo").style.display = "none";
            document.getElementById("insuranceInfo").style.display = "none";
            document.getElementById("totalCosts").style.display = "none";
            document.getElementById("spiaCheckbox").checked = false;
            document.getElementById("spiaInfo").style.display = "none";
            updateTotalCosts();
            toggleExportButton();
        }

        // Toggle SPIA Info
        function toggleSpiaInfo() {
            const spiaInfo = document.getElementById("spiaInfo");
            if (document.getElementById("spiaCheckbox").checked) {
                spiaInfo.innerHTML = `
                    <div class="section-header" onclick="toggleSection('spiaInfo')" aria-expanded="true">
                        <h3>SPIA Information</h3>
                        <button class="toggle-section"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <ul>
                            <li>No legal or administrative fees</li>
                            <li>No court process; only paperwork submission to the insurance company required</li>
                            <li>No rate caps, but deals must not be egregious</li>
                        </ul>
                    </div>
                `;
                spiaInfo.style.display = "block";
            } else {
                spiaInfo.style.display = "none";
            }
            updateTotalCosts();
            toggleExportButton();
        }

        // Toggle Export Button
        function toggleExportButton() {
            const exportButton = document.getElementById("exportButton");
            const exportTooltip = document.getElementById("exportTooltip");
            const hasContent = ["stateInfo", "insuranceInfo", "totalCosts", "spiaInfo"].some(id => document.getElementById(id).style.display === "block");
            exportButton.disabled = !hasContent;
            exportTooltip.style.display = hasContent ? "none" : "inline";
        }

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const logo = document.getElementById("headerLogo");

            if (logo.complete) {
                const canvas = document.createElement("canvas");
                canvas.width = logo.naturalWidth;
                canvas.height = logo.naturalHeight;
                canvas.getContext("2d").drawImage(logo, 0, 0);
                doc.addImage(canvas.toDataURL("image/png"), "PNG", 80, 30, 50, 20);
            }

            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("Settlement Funding Information", 105, 100, { align: "center" });
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Generated on ${new Date().toLocaleDateString()}`, 105, 110, { align: "center" });
            doc.addPage();

            let yPosition = 20;
            const sections = ["stateInfo", "insuranceInfo", "totalCosts", "spiaInfo"];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element.style.display === "block") {
                    doc.setFontSize(14);
                    const header = element.querySelector("h3").innerText;
                    yPosition = addText(doc, header, 10, yPosition, true);
                    doc.setFontSize(12);
                    element.querySelectorAll("p, li").forEach(item => {
                        yPosition = addText(doc, item.innerText.replace(/\n/g, " "), 10, yPosition + 2);
                    });
                    yPosition += 10;
                }
            });

            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text(`Page ${doc.getNumberOfPages() - 1} | Generated on ${new Date().toLocaleDateString()}`, 10, 290);
            doc.save("settlement_funding_info.pdf");

            function addText(doc, text, x, y, isBold) {
                if (isBold) doc.setFont("helvetica", "bold");
                else doc.setFont("helvetica", "normal");
                const splitText = doc.splitTextToSize(text, 190);
                splitText.forEach(line => {
                    if (y > 270) {
                        doc.setFontSize(10);
                        doc.setTextColor(150);
                        doc.text(`Page ${doc.getNumberOfPages() - 1} | Generated on ${new Date().toLocaleDateString()}`, 10, 290);
                        doc.addPage();
                        y = 10;
                    }
                    doc.text(line, x, y);
                    y += 5;
                });
                return y;
            }
        }

        // Update Total Costs
        function updateTotalCosts() {
            const spiaChecked = document.getElementById("spiaCheckbox").checked;
            const state = document.getElementById("stateSelect").value;
            const insurance = document.getElementById("insuranceSelect").value;
            const totalCosts = document.getElementById("totalCosts");

            if (spiaChecked) {
                totalCosts.innerHTML = `
                    <div class="section-header" onclick="toggleSection('totalCosts')" aria-expanded="true">
                        <h3>Total Costs</h3>
                        <button class="toggle-section"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <p>No costs associated with SPIA policies.</p>
                    </div>
                `;
                totalCosts.style.display = "block";
            } else if (state && insurance && stateData[state] && insuranceData[insurance]) {
                const legalFeeStr = stateData[state].expectedLegalFee;
                const adminFeeStr = insuranceData[insurance].adminFee;

                const legalFee = parseFee(legalFeeStr);
                const adminFee = parseFee(adminFeeStr);

                let ipaFee = 0;
                let ipaFeeHtml = '';
                if (stateData[state].requiresIPA === "Yes") {
                    ipaFee = 1500;
                    ipaFeeHtml = `<p><strong>IPA Fee:</strong> $1,500.00</p>`;
                }

                const total = legalFee + adminFee + ipaFee;

                totalCosts.innerHTML = `
                    <div class="section-header" onclick="toggleSection('totalCosts')" aria-expanded="true">
                        <h3>Total Costs</h3>
                        <button class="toggle-section"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="section-content">
                        <p><strong>Expected Legal Fee (State):</strong> ${legalFeeStr}</p>
                        <p><strong>Admin Fee (Insurance):</strong> ${adminFeeStr}</p>
                        ${ipaFeeHtml}
                        <p><strong>Total Estimated Costs:</strong> $${total.toFixed(2)}</p>
                    </div>
                `;
                totalCosts.style.display = "block";
            } else {
                totalCosts.style.display = "none";
            }
        }

        // Update Information
        function updateInfo() {
            const loading = document.getElementById("loading");
            loading.style.display = "block";
            setTimeout(() => {
                const state = document.getElementById("stateSelect").value;
                const insurance = document.getElementById("insuranceSelect").value;
                const stateInfo = document.getElementById("stateInfo");
                const insuranceInfo = document.getElementById("insuranceInfo");

                // Debug logging
                console.log("State selected:", state, "Insurance selected:", insurance);

                // Define states where Bifco issues apply with Berkshire
                const bifcoStates = ["CA", "AZ", "FL", "MS", "TX", "IN", "IL", "PA", "NY"];
                const isBerkshireSelected = insurance === "BK";
                const hasBifcoIssues = state && bifcoStates.includes(state) && isBerkshireSelected;

                // Define affidavit/declaration links
                const affDecLinks = {
                    "AZ": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/EX5OVAz2g_NPtbpMvNvXwLAB-lQhm6cehevqh_qVJf4QVQ?e=mdiqwl",
                    "CA": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/EaVi9NxoxbxGrFzsQ2iYDeUBqeoy3ZW79PI5nME-nc0t6w?e=70DlAS",
                    "FL": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/Eb68Bv5LIMhEmpjIQJEfTNYB11T9irngJDUaY_Ao11q5Zw?e=579H42",
                    "MN": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/EfP6Jno_WmRJgr_-jPGM6ywBJkUUqc03GTyJek4VILGYlQ?e=NPiDjb",
                    "NV": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/Eftca_XX8LZAvW2P1glqmBMBrMyeCnV0Emzyf1tk0Qrhhw?e=cSwHg3",
                    "NY": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/Ea4FziALeI1KuQEPA96myCkBl_ovUNEwN1Cwa1f34gzIOA?e=3BvMe3",
                    "OR": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/EeCNMEvG7G1JphaVQgWCNCoBZJTVU-yE-hXr3_lHDK90mw?e=gGDiY3",
                    "PA": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/ESlaxbDJHqVGlRouXaf-TWcBWXxfO2jkULE4BDJNlY7cEg?e=S8fuuG",
                    "TN": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/ER9UnFgLtgdGlRdCiNWyrFoB47yMWgysFkFH8kUlojNTDQ?e=1ILhFM",
                    "WI": "https://cbcsettlementfundings-my.sharepoint.com/:w:/g/personal/jrairigh_cbcsettlementfunding_com/EVcnVEL7CAVInZTMZfgAt34BfsoYSzs3qht6FF5fUi7MYw?e=fjTTcV"
                };

                // Define states with Anthony Lazzaro as underwriter
                const lazzaroStates = ["AL", "AK", "AZ", "AR", "CT", "GA", "HI", "IA", "ID", "IL", "IN", "LA", "MA", "MI", "MT", "NY", "NH", "OH", "OR", "RI", "SC", "TN", "VT", "WA", "WV", "DC"];
                const underwriter = lazzaroStates.includes(state) ? "Anthony Lazzaro" : "Mike Dalby";

                // Display state information
                if (state && stateData[state]) {
                    const data = stateData[state];
                    let additionalNotes = data.additionalNotes || "None";
                    if (hasBifcoIssues) {
                        const bifcoNote = "Bifco issues may apply with Berkshire.";
                        const bifcoTooltip = `<span class="tooltip">?<span class="tooltiptext">Bifco issues is when Berkshire sends counsel to appear at the hearing and convince the judge to deny our deal if the client agrees to go with their much better offer, but fees and work are all on the client.</span></span>`;
                        additionalNotes = additionalNotes === "None" ? bifcoNote + bifcoTooltip : additionalNotes + " " + bifcoNote + bifcoTooltip;
                    }

                    // Add icon and link for states with Affidavit or Declaration requirements
                    let affDecDisplay = data.requiresAffDec;
                    if (data.requiresAffDec !== "No" && affDecLinks[state]) {
                        const docType = data.requiresAffDec === "Aff" ? "Affidavit" : "Declaration";
                        affDecDisplay += ` <a href="${affDecLinks[state]}" target="_blank" title="Download ${docType} Document"><i class="fas fa-file-alt"></i></a>`;
                    }

                    // Format hold time display with "Days" and add tooltip
                    let holdTimeDisplay = data.holdTime;
                    if (holdTimeDisplay !== "N/A") {
                        holdTimeDisplay += " Days";
                    }
                    holdTimeDisplay += ` <span class="tooltip">?<span class="tooltiptext">number of days the state requires the client to take to make sure they're 100% comfortable with this transfer</span></span>`;

                    stateInfo.innerHTML = `
                        <div class="section-header" onclick="toggleSection('stateInfo')" aria-expanded="true">
                            <h3>${document.getElementById("stateSelect").options[document.getElementById("stateSelect").selectedIndex].text}</h3>
                            <button class="toggle-section"><i class="fas fa-chevron-down"></i></button>
                        </div>
                        <div class="section-content">
                            <p><strong>Rate Cap:</strong> ${data.rateCap}</p>
                            <p><strong>Requires IPA:</strong> ${data.requiresIPA} <span class="tooltip">?<span class="tooltiptext">Independent Professional Advice is required in some states to ensure the client understands the transaction.</span></span></p>
                            <p><strong>Requires Aff/Dec:</strong> ${affDecDisplay} <span class="tooltip">?<span class="tooltiptext">'Aff' means an Affidavit is required; 'Dec' means a Declaration is required.</span></span></p>
                            <p><strong>No Poach State:</strong> ${data.noPoachState} <span class="tooltip">?<span class="tooltiptext">A 'No Poach State' prohibits soliciting clients from other funding companies.</span></span></p>
                            <p><strong>Legal Counsel:</strong> ${data.legalCounsel}</p>
                            <p><strong>Expected Legal Fee:</strong> ${data.expectedLegalFee}</p>
                            <p><strong>Hold Time:</strong> ${holdTimeDisplay}</p>
                            <p><strong>Underwriter:</strong> ${underwriter}</p>
                            <p><strong>Additional Notes:</strong> ${additionalNotes}</p>
                        </div>
                    `;
                    stateInfo.style.display = "block";
                    console.log("State info displayed:", stateInfo.innerHTML);
                } else {
                    stateInfo.style.display = "none";
                    console.log("State info hidden: No state selected or invalid state");
                }

                // Display insurance information
                if (insurance && insuranceData[insurance]) {
                    const insData = insuranceData[insurance];
                    
                    // Check for MetLife and determine Allow Splits
                    let allowSplitsHtml = '';
                    if (insurance === "ML") { // MetLife selected
                        const allowSplitsStates = ["AK", "AZ", "IN", "MA", "NH", "SC", "WV", "MO", "DE", "FL", "KY", "ME", "MN", "NE", "NC", "PA"];
                        const allowSplits = state && allowSplitsStates.includes(state) ? "Yes" : "No";
                        allowSplitsHtml = `<p><strong>Allow Splits:</strong> ${allowSplits}</p>`;
                    }

                    insuranceInfo.innerHTML = `
                        <div class="section-header" onclick="toggleSection('insuranceInfo')" aria-expanded="true">
                            <h3>Insurance: ${insData.name}</h3>
                            <button class="toggle-section"><i class="fas fa-chevron-down"></i></button>
                        </div>
                        <div class="section-content">
                            <p><strong>Processing Notes:</strong> ${insData.notes}</p>
                            <p><strong>Does Conference Calls:</strong> ${insData.conferenceCalls} <span class="tooltip">?<span class="tooltiptext">Indicates whether the insurance company requires conference calls to confirm payment details.</span></span></p>
                            <p><strong>How to Confirm Payments:</strong> ${insData.paymentConfirmation}</p>
                            <p><strong>Credit Rating:</strong> ${insData.creditRating}</p>
                            <p><strong>Admin Fee:</strong> ${insData.adminFee}</p>
                            ${allowSplitsHtml}
                            <p><strong>Request Procedure:</strong> ${insData.requestProcedure} <span class="tooltip">?<span class="tooltiptext">Outlines the method for submitting requests, e.g., requiring a notary or accepting DocuSign.</span></span></p>
                        </div>
                    `;
                    insuranceInfo.style.display = "block";
                    console.log("Insurance info displayed:", insuranceInfo.innerHTML);
                } else {
                    insuranceInfo.style.display = "none";
                    console.log("Insurance info hidden: No insurance selected or invalid insurance");
                }

                updateTotalCosts();
                loading.style.display = "none";
                toggleExportButton();
            }, 500);
        }
    </script>
</body>
</html>